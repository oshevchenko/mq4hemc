import io
import os
import re
import datetime
"""
This is setup.py to be used from bitbake recipe.
If package is downloaded from git, the version is taken from the latest tag.
"""

version="0.0.1"
version_file = os.path.abspath(os.path.join(os.path.dirname(__file__), 'src/mq4hemc/_version.py'))
tag = os.popen('git describe --abbrev=7 --always').read().strip()
if tag:
    add_date = False
    if '-g' in tag:
        tag = tag.replace('-g', '+g')
        add_date = True
    if '-' in tag:
        tag = tag.replace('-', '.dev')
        add_date = True
    if add_date:
        # Get the current date
        date = datetime.datetime.now().strftime('.d%Y%m%d')
        # Append the date to the tag
        tag += date
    tag_list = tag.split('.')
    # Convert the tag to a version tuple
    tag_tuple = []
    for i in range(len(tag_list)):
        try:
            tag_tuple.append(int(tag_list[i]))
        except ValueError:
            break
    length = len(tag_tuple)
    if length > 0:
        tag_tuple[length - 1] += 1
    match = re.search(r'\.dev(.*)\+', tag)
    if match:
        text = match.group(1)
        tag_tuple.append('dev' + text)
    match = re.search(r'\+g(.*)', tag)
    if match:
        text = match.group(1)
        tag_tuple.append('g' + text)
    # Write the text to the file
    with open(version_file, 'w') as f:
        f.write(
"""# file generated by setup.py
# don't change, don't track in version control
TYPE_CHECKING = False
if TYPE_CHECKING:
    from typing import Tuple, Union
    VERSION_TUPLE = Tuple[Union[int, str], ...]
else:
    VERSION_TUPLE = object

version: str
__version__: str
__version_tuple__: VERSION_TUPLE
version_tuple: VERSION_TUPLE\n\n""")
    with open(version_file, 'a') as f:
        tag_str = '.'.join(str(x) for x in tag_tuple)
        tag_str = tag_str.replace('.g', '+g')
        f.write(f"__version__ = version = '{tag_str}'\n")
        tuple_str = str(tag_tuple).replace('[', '(').replace(']', ')')
        f.write(f"__version_tuple__ = version_tuple = {tuple_str}\n")
    version = tag_str

from setuptools import setup
setup(
    version=version,
)
